<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Authorizer</title>
    <style media="screen">
        html, body {
            height: 100%;
        }

        body {
            display: -ms-flexbox;
            display: flex;
            -ms-flex-align: center;
            align-items: center;
            flex-direction: column;
            padding-top: 40px;
            padding-bottom: 40px;
            background-color: #f5f5f5;
        }
        
      .vrt-authorizer-main {
          width: 100%;
          max-width: 480px;
          padding: 30px 25px;
          margin: 2rem auto;
          background: white;
          border-radius: 5px;
          box-shadow: 0 0 35px rgba(0, 0, 0, .1);
      }
    </style>
</head>
<body>
  <main class="vrt-authorizer-main">
    <h1>Authorizer</h1>
    <div class="no_access" style="display: none;">
        <p>You have no access.</p>
        <p>
            <a href="{{{authenticate}}}"><!-- href filled in by Python -->Authenticate</a>
        </p>
    </div>
    <div class="access" style="display: none;">
        <p>You have a valid token until <span class="exp">EXPIRATION</span></p>
        <p>This token was (originally) generated by <span class="azp"></span></p>
        <p class="sub_present" style="display: none;">This token was delegated to: <span class="sub"></span></p>

        <p class="all_domains" style="display: none;">You have access to all domains.</p>

        <p class="domain_limit" style="display: none;">You have access to the following domains:</p>
        <ul class="domain_limit domain_list" style="display: none;"></ul>

        <p class="access" style="display: none;">
            <a href="/delegate">Delegate (part of) this access to a third party</a>
        </p>
    </div>
  </main>

<script type="text/javascript">
    /* These variables will be filled in by the Python code when this file
     * is served.
     *
     * Epoch when the current refresh_token expires (seconds since 1970),
     * or `null` if no (valid) refresh_token was found.
     */
    var refresh_token_exp = {{{refresh_token_exp}}};  // integer or null

    /* List of domains the refresh_token has access to
     * null if no restrictions, or no token
     */
    var domains = {{{domains}}};  // array of strings, or null

    /* Token info: authenticated user and subject
     */
    var azp = {{{azp}}}; // string or null
    var sub = {{{sub}}}; // string or null

    var elements, i;
    if( refresh_token_exp === null ) {
        elements = document.getElementsByClassName('no_access');
        for(i = 0; i < elements.length; i++) {
            elements[i].style.display = '';
        }
    } else {
        elements = document.getElementsByClassName('access');
        for(i = 0; i < elements.length; i++) {
            elements[i].style.display = '';
        }

        var exp = new Date(refresh_token_exp * 1000);
        elements = document.getElementsByClassName('exp');
        for(i = 0; i < elements.length; i++) {
            elements[i].innerText = exp.toUTCString();
        }

        elements = document.getElementsByClassName('azp');
        for(i = 0; i < elements.length; i++) {
            elements[i].innerText = azp;
        }

        if(sub !== null) {
            elements = document.getElementsByClassName('sub_present');
            for (i = 0; i < elements.length; i++) {
                elements[i].style.display = '';
            }
            elements = document.getElementsByClassName('sub');
            for(i = 0; i < elements.length; i++) {
                elements[i].innerText = sub;
            }
        }

        if(domains === null) {
            elements = document.getElementsByClassName('all_domains');
            for(i = 0; i < elements.length; i++) {
                elements[i].style.display = '';
            }
        } else {
            elements = document.getElementsByClassName('domain_limit');
            for(i = 0; i < elements.length; i++) {
                elements[i].style.display = '';
            }

            elements = document.getElementsByClassName('domain_list');
            for(i = 0; i < elements.length; i++) {
                for (var d in domains) {
                    var dom = domains[d];
                    var item = document.createElement('li');
                    elements[i].appendChild(item);
                    item.appendChild(document.createTextNode(dom));
                }
            }
        }
    }
</script>
</body>
</html>
